(async function () {
  // If you are serving from GitHub Pages under /codex-ecclesia-public/,
  // codex.json should be at /codex-ecclesia-public/codex.json after build.
  const CODEX_URL = 'codex.json';

  let scrolls = [];

  const searchInput = document.getElementById('searchInput');
  const resultsGrid = document.getElementById('resultsGrid');
  const resultsEmpty = document.getElementById('resultsEmpty');
  const resultsTitle = document.getElementById('resultsTitle');

  // Fetch codex.json
  try {
    const res = await fetch(CODEX_URL, { cache: 'no-cache' });
    if (!res.ok) throw new Error('Failed to load codex.json');
    const data = await res.json();
    scrolls = Array.isArray(data.scrolls) ? data.scrolls : [];
  } catch (err) {
    console.error('Error loading codex:', err);
    if (resultsEmpty) {
      resultsEmpty.style.display = 'block';
      resultsEmpty.textContent = 'Unable to load Codex data.';
    }
    return;
  }

  function renderCard(item) {
    const div = document.createElement('div');
    div.className = 'card';

    const created = item.created ? new Date(item.created) : null;
    const createdStr = created ? created.toLocaleDateString() : '';

    div.innerHTML = `
      <h3>${item.title || 'Untitled Scroll'}</h3>
      <p style="font-size:0.85rem; color:#666; margin-bottom:0.5rem;">
        ${(item.section || '').toUpperCase()}${
          item.category ? ' • ' + item.category : ''
        }${createdStr ? ' • ' + createdStr : ''}
      </p>
      <p>${item.summary || ''}</p>
      <p style="margin-top:0.75rem;">
        <a href="${item.url}" target="_blank" rel="noopener noreferrer">Open Scroll →</a>
      </p>
    `;
    return div;
  }

  function updateResults(list, titleOverride) {
    if (!resultsGrid) return;
    resultsGrid.innerHTML = '';
    if (resultsTitle && titleOverride) {
      resultsTitle.textContent = titleOverride;
    }

    if (!list || list.length === 0) {
      if (resultsEmpty) resultsEmpty.style.display = 'block';
      return;
    }

    if (resultsEmpty) resultsEmpty.style.display = 'none';
    list.forEach(item => resultsGrid.appendChild(renderCard(item)));
  }

  // Build featured set: pinned first, then newest
  const pinned = scrolls.filter(s => s.pinned);
  const recent = [...scrolls]
    .filter(s => !s.pinned)
    .sort((a, b) => new Date(b.created || 0) - new Date(a.created || 0))
    .slice(0, Math.max(0, 6 - pinned.length));
  const featured = [...pinned, ...recent].slice(0, 6);

  updateResults(featured, 'Featured Scrolls');

  function searchScrolls(query) {
    const q = (query || '').toLowerCase().trim();
    if (!q) return featured;

    return scrolls.filter(item => {
      const haystack = [
        item.title || '',
        item.summary || '',
        item.section || '',
        item.category || '',
        ...(item.tags || [])
      ]
        .join(' ')
        .toLowerCase();

      return haystack.includes(q);
    });
  }

  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const list = searchScrolls(searchInput.value);
      const title = searchInput.value ? 'Search Results' : 'Featured Scrolls';
      updateResults(list, title);
    });
  }
})();
{
  "title": "Scroll of Jubilee Declaration",
  "path": "scrolls/scroll-of-jubilee-declaration.html",
  "section": "scrolls",
  "tags": ["jubilee", "declaration"]
}
